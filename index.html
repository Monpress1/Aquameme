<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AquaCoinX Terminal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { background-color: #0b111b; color: #ffffff; font-family: sans-serif; -webkit-tap-highlight-color: transparent; }
        .card-bg { background: #161f2c; border: 1px solid #1e293b; border-radius: 1.5rem; }
        .accent-blue { color: #3b82f6; }
        .nav-item { color: #64748b; font-size: 0.75rem; display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; }
        .nav-item.active { color: #3b82f6; }
        #modal-overlay { background: rgba(0, 0, 0, 0.95); backdrop-filter: blur(10px); display: none; }
        .input-field { background: #0b111b; border: 1px solid #334155; border-radius: 12px; padding: 14px; width: 100%; color: white; outline: none; }
        .input-field:focus { border-color: #3b82f6; }
        .network-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 6px; }
    </style>
</head>
<body class="pb-24">

    <header class="p-4 flex justify-between items-center bg-[#0b111b]/90 sticky top-0 z-40 backdrop-blur-md">
        <div class="flex items-center gap-3">
            <img src="logo.png" alt="Logo" class="w-10 h-10 rounded-lg shadow-lg shadow-blue-500/20">
            <span class="font-bold text-lg tracking-tight">AquaCoinX</span>
        </div>
        <div id="ton-connect-button"></div>
    </header>

    <main class="px-4 space-y-5 mt-2">
        <div class="card-bg p-6 relative overflow-hidden">
            <div class="flex items-center gap-4">
                <div class="w-14 h-14 rounded-2xl bg-blue-600/10 border border-blue-500/30 flex items-center justify-center">
                    <img src="logo.png" class="w-10 h-10">
                </div>
                <div>
                    <p class="text-gray-400 text-[10px] font-bold uppercase tracking-widest">Available Balance</p>
                    <h2 class="text-3xl font-black accent-blue leading-none"><span id="aqua-balance">0.00</span> <span class="text-sm align-middle">AQUAM</span></h2>
                </div>
                <span class="ml-auto bg-green-500/10 text-green-400 px-2 py-1 rounded-md text-[10px] font-black border border-green-500/20">LIVE</span>
            </div>

            <div class="grid grid-cols-2 mt-8 gap-4 border-t border-gray-700/30 pt-6">
                <div>
                    <p class="text-gray-500 text-[9px] font-bold uppercase flex items-center gap-1 mb-1">ðŸ’§ TON Balance</p>
                    <p class="text-lg font-bold"><span id="ton-balance">0.00</span> <span class="text-[10px] text-gray-500">TON</span></p>
                </div>
                <div>
                    <p class="text-gray-500 text-[9px] font-bold uppercase flex items-center gap-1 mb-1">ðŸ“ˆ USD Value</p>
                    <p class="text-lg font-bold text-green-400">$<span id="usd-value">0.00</span></p>
                </div>
            </div>
        </div>

        <h3 class="font-bold text-lg px-2">Quick Actions</h3>
        <div class="grid grid-cols-2 gap-4">
            <div onclick="openModal('Airtime')" class="card-bg p-5 flex flex-col gap-4 active:scale-95 transition-all cursor-pointer">
                <div class="w-10 h-10 bg-blue-500/10 rounded-xl flex items-center justify-center"><i class="fa-solid fa-mobile-screen accent-blue text-xl"></i></div>
                <div><p class="font-bold">Airtime</p><p class="text-gray-500 text-[10px]">Top up credit</p></div>
            </div>
            <div onclick="openModal('Data')" class="card-bg p-5 flex flex-col gap-4 active:scale-95 transition-all cursor-pointer">
                <div class="w-10 h-10 bg-blue-500/10 rounded-xl flex items-center justify-center"><i class="fa-solid fa-wifi accent-blue text-xl"></i></div>
                <div><p class="font-bold">Data (MB)</p><p class="text-gray-500 text-[10px]">High speed bundles</p></div>
            </div>
            <div onclick="openModal('Cable')" class="card-bg p-5 flex flex-col gap-4 active:scale-95 transition-all cursor-pointer">
                <div class="w-10 h-10 bg-orange-500/10 rounded-xl flex items-center justify-center"><i class="fa-solid fa-tv text-orange-500 text-xl"></i></div>
                <div><p class="font-bold">Cable TV</p><p class="text-gray-500 text-[10px]">Subscriptions</p></div>
            </div>
            <div onclick="openModal('Bills')" class="card-bg p-5 flex flex-col gap-4 active:scale-95 transition-all cursor-pointer">
                <div class="w-10 h-10 bg-green-500/10 rounded-xl flex items-center justify-center"><i class="fa-solid fa-bolt text-green-500 text-xl"></i></div>
                <div><p class="font-bold">Bills</p><p class="text-gray-500 text-[10px]">Utilities</p></div>
            </div>
        </div>

        <div class="card-bg p-6">
            <h3 class="font-bold text-sm mb-4">Spending Analytics</h3>
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-[#0b111b] p-4 rounded-2xl border border-gray-800">
                    <p class="text-gray-500 text-[10px] font-bold">Total Spent</p>
                    <p class="text-lg font-black accent-blue"><span id="total-spent">0</span> AQUAM</p>
                </div>
                <div class="bg-[#0b111b] p-4 rounded-2xl border border-gray-800">
                    <p class="text-gray-500 text-[10px] font-bold">Active Services</p>
                    <p class="text-lg font-black" id="tx-count">0</p>
                </div>
            </div>
        </div>
    </main>

    <nav class="fixed bottom-0 w-full bg-[#0b111b]/95 border-t border-gray-800 p-4 flex justify-around items-center z-50 backdrop-blur-md">
        <div class="nav-item active"><i class="fa-solid fa-house"></i>Home</div>
        <div class="nav-item"><i class="fa-solid fa-table-cells-large"></i>Services</div>
        <div class="nav-item"><i class="fa-solid fa-clock-rotate-left"></i>History</div>
        <div class="nav-item"><i class="fa-solid fa-gear"></i>Settings</div>
    </nav>

    <div id="modal-overlay" class="fixed inset-0 z-[60] flex items-end sm:items-center justify-center p-4">
        <div class="card-bg w-full max-w-md p-6 space-y-5 animate-in slide-in-from-bottom duration-300">
            <div class="flex justify-between items-center">
                <h2 id="modal-title" class="text-xl font-black">Buy Service</h2>
                <button onclick="closeModal()" class="w-8 h-8 flex items-center justify-center bg-gray-800 rounded-full"><i class="fa-solid fa-xmark"></i></button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Network Provider</label>
                    <select id="network-select" class="input-field mt-1">
                        <option value="mtn"><span class="network-dot bg-yellow-400"></span>ðŸŸ¡ MTN</option>
                        <option value="airtel">ðŸ”´ Airtel</option>
                        <option value="glo">ðŸŸ¢ Glo</option>
                        <option value="9mobile">ðŸŸ¢ 9mobile</option>
                    </select>
                </div>

                <div id="data-bundle-section" style="display: none;">
                    <label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Select MB/GB Bundle</label>
                    <select id="bundle-select" class="input-field mt-1" onchange="updateBundlePrice()">
                        <option value="100" data-price="100">100MB - 100 NGN</option>
                        <option value="500" data-price="500">500MB - 500 NGN</option>
                        <option value="1000" data-price="1000">1GB - 1,000 NGN</option>
                        <option value="2000" data-price="2000">2.5GB - 2,000 NGN</option>
                        <option value="5000" data-price="5000">10GB - 5,000 NGN</option>
                    </select>
                </div>

                <div>
                    <label id="input-label" class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Phone Number</label>
                    <input type="number" id="id-input" placeholder="080XXXXXXXX" class="input-field mt-1" oninput="validateForm()">
                </div>

                <div id="price-section">
                    <label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Amount (NGN)</label>
                    <input type="number" id="price-input" placeholder="Min 50" class="input-field mt-1" oninput="validateForm()">
                </div>

                <div class="bg-blue-600/10 border border-blue-500/20 p-4 rounded-xl flex justify-between items-center">
                    <span class="text-xs font-bold text-gray-400 uppercase">Payment Due</span>
                    <span class="text-lg font-black accent-blue"><span id="calc-aquam">0</span> AQUAM</span>
                </div>

                <button id="pay-btn" onclick="executePayment()" class="w-full py-4 bg-gray-800 rounded-2xl font-bold text-lg opacity-30 pointer-events-none transition-all">
                    Pay with AQUAM
                </button>
                <p id="balance-warning" class="text-[10px] text-red-500 text-center font-bold hidden">INSUFFICIENT AQUAM BALANCE</p>
            </div>
        </div>
    </div>

    <script>
        const AQUA_MASTER = "EQA71L6_7UY_aENYSZ_cfbFyUz8SsufxTWyN5Ac80BtX8W9d";
        const TREASURY = "EQCD39VS5jcptHL8vMjEXrzGaRcCVYto7HUn4bpAOg8xqB2N";
        const NGN_RATE = 1.2; // 1 NGN = 1.2 AQUAM (Adjust as you like)

        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: 'https://raw.githubusercontent.com/ton-connect/demo-dapp-with-react-ui/master/public/tonconnect-manifest.json',
            buttonRootId: 'ton-connect-button'
        });

        let userAddress = "", userJettonWallet = "", currentType = "", currentBal = 0;

        tonConnectUI.onStatusChange(w => { if(w) { userAddress = w.account.address; refreshData(); } });

        async function refreshData() {
            if(!userAddress) return;
            try {
                const t = await (await fetch(`https://tonapi.io/v2/accounts/${userAddress}`)).json();
                document.getElementById('ton-balance').innerText = (t.balance / 1e9).toFixed(2);
                
                const j = await (await fetch(`https://tonapi.io/v2/accounts/${userAddress}/jettons`)).json();
                const aqua = j.balances.find(i => i.jetton.address.includes(AQUA_MASTER));
                if(aqua) {
                    currentBal = Number(aqua.balance) / 1e9;
                    userJettonWallet = aqua.wallet_address.address;
                    document.getElementById('aqua-balance').innerText = currentBal.toLocaleString(undefined, {minimumFractionDigits: 2});
                    document.getElementById('usd-value').innerText = (currentBal * 0.05).toFixed(2);
                }
            } catch(e) { console.error("Update Fail"); }
        }

        // Auto-refresh every 15 seconds
        setInterval(refreshData, 15000);

        function openModal(t) {
            currentType = t;
            refreshData(); // Check balance before starting
            document.getElementById('modal-title').innerText = `Buy ${t}`;
            document.getElementById('modal-overlay').style.display = 'flex';
            
            const isData = t === 'Data';
            document.getElementById('data-bundle-section').style.display = isData ? 'block' : 'none';
            document.getElementById('price-section').style.display = isData ? 'none' : 'block';
            
            document.getElementById('input-label').innerText = t === 'Bills' ? 'Meter Number' : t === 'Cable' ? 'Smart Card' : 'Phone Number';
            
            if(isData) updateBundlePrice();
            validateForm();
        }

        function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }

        function updateBundlePrice() {
            const select = document.getElementById('bundle-select');
            const price = select.options[select.selectedIndex].getAttribute('data-price');
            document.getElementById('price-input').value = price;
            validateForm();
        }

        function validateForm() {
            const idVal = document.getElementById('id-input').value;
            const ngn = document.getElementById('price-input').value;
            const calcSpan = document.getElementById('calc-aquam');
            const btn = document.getElementById('pay-btn');
            const warning = document.getElementById('balance-warning');

            const cost = (ngn * NGN_RATE).toFixed(2);
            calcSpan.innerText = cost;

            const hasFunds = currentBal >= parseFloat(cost);
            const isValidInput = idVal.length >= 10 && idVal.length <= 11 && ngn >= 50;

            if(isValidInput && hasFunds) {
                btn.classList.remove('opacity-30', 'pointer-events-none', 'bg-gray-800');
                btn.classList.add('bg-blue-600');
                warning.classList.add('hidden');
            } else {
                btn.classList.add('opacity-30', 'pointer-events-none', 'bg-gray-800');
                btn.classList.remove('bg-blue-600');
                if(!hasFunds && ngn > 0) warning.classList.remove('hidden');
                else warning.classList.add('hidden');
            }
        }

        async function executePayment() {
            const cost = document.getElementById('calc-aquam').innerText;
            if(!userJettonWallet) return alert("Connect Wallet!");
            
            try {
                // Generate the Jetton transfer payload
                const res = await fetch(`https://ton-payload-generator.vercel.app/api/transfer`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        to: TREASURY, 
                        amount: (parseFloat(cost) * 1e9).toString(), 
                        responseAddress: userAddress 
                    })
                });
                
                const { payload } = await res.json();

                await tonConnectUI.sendTransaction({
                    validUntil: Math.floor(Date.now()/1000) + 300,
                    messages: [{ 
                        address: userJettonWallet, 
                        amount: "50000000", // 0.05 TON for processing gas
                        payload: payload 
                    }]
                });

                alert(`Request Sent! ${cost} AQUAM will be deducted once confirmed.`);
                closeModal();
                setTimeout(refreshData, 3000);
            } catch(e) { 
                alert("Payment Cancelled or Failed."); 
            }
        }
    </script>
</body>
</html>
