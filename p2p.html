<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>P2P Transfer | AquaCoinX</title>

<script src="https://cdn.jsdelivr.net/npm/tonweb@0.0.66/dist/tonweb.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
    :root { --bg: #0b111b; --card: #131b29; --border: #1e293b; --text: #ffffff; --subtext: #94a3b8; --primary: #3b82f6; --accent: #22c55e; }
    body.light-mode { --bg: #f1f5f9; --card: #ffffff; --border: #cbd5e1; --text: #0f172a; --subtext: #64748b; }
    body { background: var(--bg); color: var(--text); font-family: 'Manrope', sans-serif; -webkit-tap-highlight-color: transparent; transition: 0.3s; margin: 0; padding: 0; }
    
    .card-bg { background: var(--card); border: 1px solid var(--border); border-radius: 1.25rem; position: relative; overflow: hidden; transition: 0.2s; }
    
    .input { background: var(--bg); border: 1px solid var(--border); border-radius: 14px; padding: 16px; width: 100%; color: var(--text); outline: none; font-weight: 600; appearance: none; }
    .input:focus { border-color: var(--primary); }
    
    .nav-item { color: var(--subtext); display: flex; flex-direction: column; align-items: center; font-size: 0.7rem; gap: 6px; font-weight: 600; cursor: pointer; }
    .nav-item.active { color: var(--primary); }

    #ton-connect button { background: var(--primary) !important; color: white !important; border-radius: 12px !important; }

    /* Custom Toggle Switch */
    .p2p-toggle { background: var(--bg); border: 1px solid var(--border); border-radius: 12px; padding: 4px; display: flex; }
    .p2p-tab { flex: 1; text-align: center; padding: 10px; font-size: 13px; font-weight: 800; border-radius: 8px; cursor: pointer; transition: 0.3s; color: var(--subtext); }
    .p2p-tab.active-tab { background: var(--card); color: var(--text); box-shadow: 0 4px 12px rgba(0,0,0,0.2); border: 1px solid var(--border); }

    /* Asset Selector */
    .asset-pill { padding: 8px 16px; border-radius: 20px; border: 1px solid var(--border); font-size: 12px; font-weight: 700; cursor: pointer; opacity: 0.5; transition: 0.2s; display: flex; align-items: center; gap: 6px; }
    .asset-pill.selected { background: var(--primary); border-color: var(--primary); color: white; opacity: 1; }

    .loader-ring { display: inline-block; width: 20px; height: 20px; }
    .loader-ring:after { content: " "; display: block; width: 18px; height: 18px; margin: 1px; border-radius: 50%; border: 2px solid #fff; border-color: #fff transparent #fff transparent; animation: ring 1.2s linear infinite; }
    @keyframes ring { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
</head>

<body class="pb-28 select-none">

<header class="px-5 py-4 flex justify-between items-center sticky top-0 z-40 border-b border-gray-800/20" style="background-color: var(--bg)">
  <div class="flex items-center gap-3">
    <div onclick="window.history.back()" class="w-10 h-10 rounded-full bg-gray-800/50 flex items-center justify-center text-white cursor-pointer hover:bg-gray-700 transition">
        <i class="fa-solid fa-arrow-left"></i>
    </div>
    <div>
      <div class="font-extrabold text-lg tracking-tight">P2P Transfer</div>
      <div id="status" class="text-[10px] font-bold text-gray-500 uppercase tracking-wider flex items-center gap-2">
        <i class="fa-solid fa-circle text-[6px] text-red-500"></i> Disconnected
      </div>
    </div>
  </div>
  <div id="ton-connect"></div>
</header>

<main class="p-5 space-y-6">

    <div class="p2p-toggle">
        <div onclick="setMode('send')" id="tab-send" class="p2p-tab active-tab">SEND CRYPTO</div>
        <div onclick="setMode('sell')" id="tab-sell" class="p2p-tab">SELL TO CASH</div>
    </div>

    <div class="card-bg p-6 text-center">
        <p class="text-xs font-bold uppercase tracking-widest mb-2" style="color: var(--subtext)">Wallet Balance</p>
        <h2 class="text-4xl font-black tracking-tight flex items-center justify-center gap-2">
            <span id="displayBal">0.00</span> 
            <span id="displayTicker" class="text-lg font-bold text-blue-500">TON</span>
        </h2>
    </div>

    <div id="view-send" class="space-y-6">
        <div class="flex gap-3 justify-center">
            <div onclick="selectAsset('TON')" id="asset-ton" class="asset-pill selected">
                <div class="w-4 h-4 rounded-full bg-blue-500 flex items-center justify-center text-[8px] text-white">T</div> TON
            </div>
            <div onclick="selectAsset('AQUAM')" id="asset-aquam" class="asset-pill">
                <div class="w-4 h-4 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold text-[8px]">A</div> AQUAM
            </div>
        </div>

        <div class="card-bg p-5 space-y-4">
            <div>
                <label class="text-[10px] uppercase font-extrabold mb-2 block opacity-50 tracking-widest">Recipient Address</label>
                <div class="relative">
                    <input id="p2pAddress" type="text" placeholder="Paste Wallet Address (UQ...)" class="input pr-10">
                    <button onclick="pasteAddress()" class="absolute right-3 top-1/2 -translate-y-1/2 text-blue-500 text-sm font-bold">PASTE</button>
                </div>
            </div>

            <div>
                <label class="text-[10px] uppercase font-extrabold mb-2 block opacity-50 tracking-widest">Amount to Send</label>
                <div class="relative">
                    <input id="p2pAmount" type="number" placeholder="0.00" class="input">
                    <button onclick="setMax()" class="absolute right-3 top-1/2 -translate-y-1/2 text-xs bg-blue-500/20 text-blue-400 px-2 py-1 rounded font-bold hover:bg-blue-500 hover:text-white transition">MAX</button>
                </div>
            </div>
        </div>

        <button id="sendBtn" onclick="executeTransfer()" class="w-full py-5 bg-blue-600 rounded-2xl font-black text-white shadow-xl shadow-blue-500/20 flex items-center justify-center gap-3 transition hover:scale-[1.02]">
            <i class="fa-solid fa-paper-plane"></i> SEND ASSETS
        </button>
    </div>

    <div id="view-sell" class="space-y-6 hidden">
        <div class="card-bg p-6 border-green-500/20 relative overflow-hidden">
            <div class="absolute -right-5 -top-5 w-24 h-24 bg-green-500/20 rounded-full blur-2xl"></div>
            <h3 class="text-xl font-black text-white mb-2">Cash Out via Transak</h3>
            <p class="text-sm text-gray-400 leading-relaxed mb-4">Sell your AQUAM or TON directly to your bank account or card. Supported in 150+ countries.</p>
            
            <div class="flex flex-col gap-2 mb-4">
                <div class="flex items-center gap-3 text-xs font-bold text-gray-500">
                    <i class="fa-solid fa-check text-green-500"></i> Instant Bank Transfer
                </div>
                <div class="flex items-center gap-3 text-xs font-bold text-gray-500">
                    <i class="fa-solid fa-check text-green-500"></i> Visa / Mastercard
                </div>
            </div>
        </div>

        <button onclick="openTransak()" class="w-full py-5 bg-green-600 rounded-2xl font-black text-white shadow-xl shadow-green-500/20 flex items-center justify-center gap-3 transition hover:scale-[1.02]">
            <i class="fa-solid fa-building-columns"></i> SELL FOR FIAT (CASH)
        </button>
        
        <p class="text-center text-[10px] uppercase font-bold opacity-40">Redirects to Transak Secure Gateway</p>
    </div>

</main>

<nav class="fixed bottom-0 left-0 right-0 backdrop-blur-md border-t border-gray-800/30 px-6 flex justify-between items-center z-50 h-[80px]" style="background-color: var(--bg)">
    <div onclick="window.location.href='index.html'" class="nav-item"><i class="fa-solid fa-house-chimney text-lg"></i><span>Home</span></div>
    <div class="nav-item active"><i class="fa-solid fa-money-bill-transfer text-lg"></i><span>P2P</span></div>
    <div onclick="window.location.href='apps.html'" class="nav-item"><i class="fa-solid fa-shopping-cart text-lg"></i><span>Apps</span></div>
    <div onclick="window.location.href='settings.html'" class="nav-item"><i class="fa-solid fa-sliders text-lg"></i><span>Settings</span></div>
</nav>

<script>
// --- CONFIGURATION ---
const AQUA_MASTER = "0:3bd4bebfed463f684358499fdc7db172533f12b2e7f14d6c8de4073cd01b57f1"; 
const API = "https://tonapi.io/v2";

// Transak Configuration (Using standard staging/demo key for this template - Replace with Production Key)
const TRANSAK_API_KEY = "4fcd6904-7061-4096-9803-22647b95287e"; // Public Demo Key
const TRANSAK_ENV = "STAGING"; // Change to 'PRODUCTION' when live

let userAddress = "";
let jettonWallet = "";
let currentAsset = "TON"; 
let balances = { TON: 0, AQUAM: 0 };

const tonUI = new TON_CONNECT_UI.TonConnectUI({
  manifestUrl: "https://raw.githubusercontent.com/ton-connect/demo-dapp-with-react-ui/master/public/tonconnect-manifest.json",
  buttonRootId: "ton-connect"
});

// --- INIT ---
tonUI.onStatusChange(async wallet => {
  if (!wallet) {
    document.getElementById("status").innerHTML = '<i class="fa-solid fa-circle text-[6px] text-red-500"></i> Disconnected';
    userAddress = "";
    document.getElementById("sendBtn").classList.add("opacity-50", "pointer-events-none");
    return;
  }
  userAddress = wallet.account.address;
  document.getElementById("status").innerHTML = '<i class="fa-solid fa-circle text-[6px] text-green-500"></i> Connected';
  document.getElementById("sendBtn").classList.remove("opacity-50", "pointer-events-none");
  loadBalances();
});

// --- CORE FUNCTIONS ---

async function loadBalances() {
  try {
      // 1. Get TON Balance
      const acc = await fetch(`${API}/accounts/${userAddress}`).then(r => r.json());
      balances.TON = acc.balance / 1e9;
      
      // 2. Get Jetton (AQUAM) Balance
      const jets = await fetch(`${API}/accounts/${userAddress}/jettons`).then(r => r.json());
      const aqua = jets.balances.find(j => j.jetton.address === AQUA_MASTER);
      
      if (aqua) {
        balances.AQUAM = Number(aqua.balance) / 1e9;
        // Save the user's specific Jetton Wallet address for sending
        jettonWallet = new TonWeb.utils.Address(aqua.wallet_address.address).toString(true, true, true);
      } else {
        balances.AQUAM = 0;
      }
      
      updateDisplay();
  } catch(e) { console.error("Balance Error:", e); }
}

function updateDisplay() {
    const val = balances[currentAsset];
    document.getElementById("displayBal").innerText = val.toLocaleString(undefined, {maximumFractionDigits: 4});
    document.getElementById("displayTicker").innerText = currentAsset;
}

function selectAsset(asset) {
    currentAsset = asset;
    document.querySelectorAll('.asset-pill').forEach(el => el.classList.remove('selected'));
    document.getElementById(`asset-${asset.toLowerCase()}`).classList.add('selected');
    updateDisplay();
}

function setMode(mode) {
    document.querySelectorAll('.p2p-tab').forEach(el => el.classList.remove('active-tab'));
    document.getElementById(`tab-${mode}`).classList.add('active-tab');
    
    if(mode === 'send') {
        document.getElementById('view-send').classList.remove('hidden');
        document.getElementById('view-sell').classList.add('hidden');
    } else {
        document.getElementById('view-send').classList.add('hidden');
        document.getElementById('view-sell').classList.remove('hidden');
    }
}

function setMax() {
    let max = balances[currentAsset];
    // Leave dust for gas if TON
    if(currentAsset === 'TON') max = max > 0.05 ? max - 0.05 : 0;
    document.getElementById("p2pAmount").value = max.toFixed(4);
}

async function pasteAddress() {
    try {
        const text = await navigator.clipboard.readText();
        document.getElementById("p2pAddress").value = text;
    } catch (err) {
        alert("Permission to read clipboard denied");
    }
}

// --- TRANSFER LOGIC ---

async function executeTransfer() {
    const recipient = document.getElementById("p2pAddress").value;
    const amount = parseFloat(document.getElementById("p2pAmount").value);
    const btn = document.getElementById("sendBtn");

    // Validation
    if(!userAddress) return alert("Connect Wallet First");
    if(!recipient) return alert("Enter Recipient Address");
    if(!amount || amount <= 0) return alert("Enter Valid Amount");
    if(amount > balances[currentAsset]) return alert("Insufficient Balance");

    const originalText = btn.innerHTML;
    btn.innerHTML = `<div class="loader-ring"></div> Processing...`;
    btn.classList.add("pointer-events-none", "opacity-80");

    try {
        if(currentAsset === 'TON') {
            // SEND TON (Native)
            const amtNano = TonWeb.utils.toNano(amount.toString());
            await tonUI.sendTransaction({
                validUntil: Math.floor(Date.now() / 1000) + 300,
                messages: [{
                    address: recipient,
                    amount: amtNano.toString()
                }]
            });
        } else {
            // SEND AQUAM (Jetton)
            if(!jettonWallet) throw new Error("No Aquam Wallet found for this account");
            
            const amtNano = BigInt(Math.floor(amount * 1e9)); // Assuming 9 decimals
            
            // Construct Jetton Transfer Body
            const cell = new TonWeb.boc.Cell();
            cell.bits.writeUint(0xf8a7ea5, 32); // OpCode: transfer
            cell.bits.writeUint(0, 64); // QueryID
            cell.bits.writeCoins(amtNano); // Jetton Amount
            cell.bits.writeAddress(new TonWeb.utils.Address(recipient)); // Destination
            cell.bits.writeAddress(new TonWeb.utils.Address(userAddress)); // Response Destination
            cell.bits.writeBit(0); // Custom Payload (null)
            cell.bits.writeCoins(TonWeb.utils.toNano("0.001")); // Forward Amount
            cell.bits.writeBit(0); // Forward Payload (null)

            const payload = TonWeb.utils.bytesToBase64(await cell.toBoc());

            await tonUI.sendTransaction({
                validUntil: Math.floor(Date.now() / 1000) + 300,
                messages: [{
                    address: jettonWallet, // Send to YOUR Jetton Wallet Contract
                    amount: TonWeb.utils.toNano("0.05").toString(), // Gas for processing
                    payload: payload
                }]
            });
        }

        alert("Transaction Sent Successfully!");
        document.getElementById("p2pAmount").value = "";
        loadBalances(); // Refresh
    } catch(e) {
        console.error(e);
        if(e.message.includes("User rejected")) return; // Don't alert on cancel
        alert("Transaction Failed: " + e.message);
    } finally {
        btn.innerHTML = originalText;
        btn.classList.remove("pointer-events-none", "opacity-80");
    }
}

// --- TRANSAK INTEGRATION ---

function openTransak() {
    // We construct a URL to open Transak with pre-filled parameters
    // We default to selling TON. Transak automatically handles the bank details step.
    
    const cryptoCurrencyCode = 'TON'; 
    const walletAddress = userAddress; 
    
    // Constructing the URL
    // Note: 'productsAvailed=SELL' locks the widget to Sell mode
    let url = `https://global.transak.com?apiKey=${TRANSAK_API_KEY}&cryptoCurrencyCode=${cryptoCurrencyCode}&productsAvailed=SELL`;
    
    if(walletAddress) {
        url += `&walletAddress=${walletAddress}`;
    }
    
    // Open in new window/tab for security and better UX on mobile
    window.open(url, '_blank');
}

</script>
</body>
</html>
